<!-- –í–∫–ª–∞–¥–∫–∞: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö -->
<div class="workflow-tab">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∫–ª–∞–¥–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-building stat-card-icon"></i>
                <div class="card-body">
                    <h6>–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</h6>
                    <h3 data-stat="suppliers_count">{{ data_collection_stats.suppliers_count if data_collection_stats else 0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-send stat-card-icon"></i>
                <div class="card-body">
                    <h6>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h6>
                    <h3 data-stat="requests_active">{{ data_collection_stats.requests_active if data_collection_stats else 0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-check-circle stat-card-icon"></i>
                <div class="card-body">
                    <h6>–ü–æ–ª—É—á–µ–Ω–æ</h6>
                    <h3 data-stat="requests_received">{{ data_collection_stats.requests_received if data_collection_stats else 0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-clock stat-card-icon"></i>
                <div class="card-body">
                    <h6>–û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</h6>
                    <h3 data-stat="requests_pending">{{ data_collection_stats.requests_pending if data_collection_stats else 0 }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="mb-4">
        <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('main.new_supplier') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
            </a>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#sendRequestModal">
                <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
            </button>
            <a href="{{ url_for('main.categories') }}" class="btn btn-outline-primary">
                <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω
            </a>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
    <div class="card mb-4" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small text-muted mb-1">–ü–æ–∏—Å–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchSuppliers" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∫–æ–¥..." onkeyup="filterTable('suppliersTable', this.value)">
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted mb-1">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É</label>
                    <select class="form-select" id="filterSupplierStatus" onchange="filterTable('suppliersTable', document.getElementById('searchSuppliers').value, this.value)">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="has_data">üü¢ –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ</option>
                        <option value="waiting">üü° –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</option>
                        <option value="no_response">üî¥ –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞</option>
                        <option value="new">‚ö™ –ù–æ–≤—ã–π</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted mb-1">–ü–æ–∏—Å–∫ –∑–∞–ø—Ä–æ—Å–æ–≤</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchRequests" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..." onkeyup="filterTable('requestsTable', this.value)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±—ã –≤–Ω—É—Ç—Ä–∏ –≤–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-pills mb-3" id="dataCollectionTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="suppliers-tab" data-bs-toggle="tab" data-bs-target="#suppliers-list" type="button" role="tab">
                –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests-list" type="button" role="tab">
                –ó–∞–ø—Ä–æ—Å—ã –¥–∞–Ω–Ω—ã—Ö
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- –†–∞–∑–¥–µ–ª: –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ -->
        <div class="tab-pane fade show active" id="suppliers-list" role="tabpanel">
            <div class="card" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: none;">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="suppliersTable">
                            <thead>
                                <tr>
                                    <th>–ö–æ–¥</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</th>
                                    <th>–ó–∞–ø—Ä–æ—Å—ã</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTableBody">
                                {% if suppliers_with_requests %}
                                    {% for supplier_data in suppliers_with_requests %}
                                    <tr>
                                        <td><code>{{ supplier_data.supplier.code }}</code></td>
                                        <td><strong>{{ supplier_data.supplier.name }}</strong></td>
                                        <td>
                                            {% for category in supplier_data.supplier.categories.all()[:3] %}
                                                <span class="badge bg-secondary">{{ category.name }}</span>
                                            {% endfor %}
                                            {% if supplier_data.supplier.categories.count() > 3 %}
                                                <span class="badge bg-secondary">+{{ supplier_data.supplier.categories.count() - 3 }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>
                                                –í—Å–µ–≥–æ: {{ supplier_data.stats.total }}<br>
                                                –ê–∫—Ç–∏–≤–Ω—ã—Ö: {{ supplier_data.stats.request_sent }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if supplier_data.overall_status == 'has_data' %}
                                                <span class="badge bg-success">üü¢ –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
                                            {% elif supplier_data.overall_status == 'waiting' %}
                                                <span class="badge bg-warning">üü° –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</span>
                                            {% elif supplier_data.overall_status == 'no_response' %}
                                                <span class="badge bg-danger">üî¥ –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞</span>
                                            {% else %}
                                                <span class="badge bg-secondary">‚ö™ –ù–æ–≤—ã–π</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" 
                                                        onclick="sendRequest({{ supplier_data.supplier.id }})"
                                                        title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å">
                                                    <i class="bi bi-send"></i>
                                                </button>
                                                <a href="{{ url_for('main.edit_supplier', supplier_id=supplier_data.supplier.id) }}" 
                                                   class="btn btn-outline-secondary"
                                                   title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <a href="{{ url_for('main.suppliers') }}?supplier_id={{ supplier_data.supplier.id }}" 
                                                   class="btn btn-outline-info"
                                                   title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-5">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="bi bi-building"></i>
                                                </div>
                                                <div class="empty-state-title">–ù–µ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</div>
                                                <div class="empty-state-text">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</div>
                                                <a href="{{ url_for('main.new_supplier') }}" class="btn btn-primary">
                                                    <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- –†–∞–∑–¥–µ–ª: –ó–∞–ø—Ä–æ—Å—ã –¥–∞–Ω–Ω—ã—Ö -->
        <div class="tab-pane fade" id="requests-list" role="tabpanel">
            <div class="card" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: none;">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="requestsTable">
                            <thead>
                                <tr>
                                    <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–°—Ä–æ–∫</th>
                                    <th>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</th>
                                    <th>–ü–æ–ª—É—á–µ–Ω–æ</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="requestsTableBody">
                                {% if data_requests %}
                                    {% for request in data_requests %}
                                    <tr>
                                        <td><strong>{{ request.supplier.name if request.supplier else 'N/A' }}</strong></td>
                                        <td>{{ request.category.name if request.category else 'N/A' }}</td>
                                        <td>
                                            {% set subcat_ids = request.get_subcategory_ids() %}
                                            {% if subcat_ids %}
                                                {% for subcat_id in subcat_ids[:2] %}
                                                    {% if all_subcategories[subcat_id] %}
                                                        <span class="badge bg-light text-dark">{{ all_subcategories[subcat_id].name }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                                {% if subcat_ids|length > 2 %}
                                                    <span class="badge bg-light text-dark">+{{ subcat_ids|length - 2 }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if request.status.value == 'new' %}
                                                <span class="badge bg-secondary">–ù–æ–≤—ã–π</span>
                                            {% elif request.status.value == 'request_sent' %}
                                                <span class="badge bg-primary">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>
                                            {% elif request.status.value == 'data_received' %}
                                                <span class="badge bg-success">–ü–æ–ª—É—á–µ–Ω–æ</span>
                                            {% elif request.status.value == 'no_response' %}
                                                <span class="badge bg-danger">–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞</span>
                                            {% elif request.status.value == 'cancelled' %}
                                                <span class="badge bg-secondary">–û—Ç–º–µ–Ω–µ–Ω</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if request.deadline %}
                                                {% if request.is_overdue() %}
                                                    <span class="text-danger">
                                                        <i class="bi bi-exclamation-triangle"></i> {{ request.deadline.strftime('%d.%m.%Y') }}
                                                    </span>
                                                {% else %}
                                                    {{ request.deadline.strftime('%d.%m.%Y') }}
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if request.request_sent_at %}
                                                {{ request.request_sent_at.strftime('%d.%m.%Y %H:%M') }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if request.data_received_at %}
                                                {{ request.data_received_at.strftime('%d.%m.%Y %H:%M') }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if request.status.value == 'request_sent' %}
                                                    <button class="btn btn-outline-success" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" 
                                                            title="–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–æ"
                                                            onclick="markReceived({{ request.id }})">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                {% endif %}
                                                <button class="btn btn-outline-info" 
                                                        data-bs-toggle="tooltip" 
                                                        data-bs-placement="top" 
                                                        title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏"
                                                        onclick="viewRequest({{ request.id }})">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                {% if request.status.value != 'data_received' and request.status.value != 'cancelled' %}
                                                    <button class="btn btn-outline-danger" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" 
                                                            title="–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å"
                                                            onclick="cancelRequest({{ request.id }})">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="bi bi-envelope"></i>
                                                </div>
                                                <div class="empty-state-title">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–∞–Ω–Ω—ã—Ö</div>
                                                <div class="empty-state-text">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</div>
                                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#sendRequestModal">
                                                    <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

