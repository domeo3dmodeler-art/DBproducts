# WORKFLOW СБОРА ДАННЫХ ОТ ПОСТАВЩИКОВ

**Дата:** 2024  
**Версия:** 2.0  
**Статус:** Переосмысление с учетом новых требований

---

## 1. ПОНИМАНИЕ ЗАДАЧИ

### 1.1. Новые требования

Первая вкладка должна называться **"Сбор данных"** и включать:

1. **Создание поставщиков** - регистрация новых поставщиков в системе
2. **Привязка к категориям** - поставщик может быть привязан к нескольким категориям
3. **Отправка запросов** - отметка о том, какому поставщику по каким категориям/подкатегориям отправлен запрос на предоставление данных
4. **Отслеживание получения** - контроль получения информации от поставщиков

### 1.2. Бизнес-логика

**Цель:** Управление процессом сбора данных от поставщиков от момента регистрации до получения файлов.

**Преимущества:**
- Прозрачность процесса сбора данных
- Контроль запросов к поставщикам
- Отслеживание статусов получения данных
- Планирование работы с поставщиками

---

## 2. ПЕРЕОСМЫСЛЕННЫЙ WORKFLOW

### 2.1. Полный жизненный цикл данных

```
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 1: СБОР ДАННЫХ                                         │
│  Регистрация поставщиков, отправка запросов,                │
│  отслеживание получения информации                           │
│  Статусы: new, request_sent, data_received, no_response      │
└─────────────────────────────────────────────────────────────┘
                    ↓ (получен файл)
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 2: В ОБРАБОТКЕ                                         │
│  Файлы импортируются и готовятся                             │
│  Статус: processing                                           │
└─────────────────────────────────────────────────────────────┘
                    ↓ (импорт завершен)
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 3: В КАТАЛОГЕ                                          │
│  Данные загружены в каталог, товары созданы                  │
│  Статус: in_catalog                                          │
└─────────────────────────────────────────────────────────────┘
                    ↓ (экспорт в основную БД)
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 4: ЭКСПОРТИРОВАНО                                      │
│  Данные выгружены в основную БД                              │
│  Статус: exported                                            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2. Названия вкладок (финальный вариант)

1. **Сбор данных** - регистрация поставщиков, запросы, отслеживание получения
2. **В обработке** - импорт и подготовка файлов
3. **В каталоге** - товары в системе
4. **Экспортировано** - данные в основной БД

---

## 3. АРХИТЕКТУРА ДАННЫХ

### 3.1. Новая модель: DataRequest (Запрос данных)

```python
class DataRequestStatus(enum.Enum):
    """Статусы запросов данных"""
    NEW = 'new'                    # Новый поставщик, запрос еще не отправлен
    REQUEST_SENT = 'request_sent'   # Запрос отправлен поставщику
    DATA_RECEIVED = 'data_received' # Данные получены от поставщика
    NO_RESPONSE = 'no_response'     # Нет ответа от поставщика
    CANCELLED = 'cancelled'         # Запрос отменен

class DataRequest(db.Model):
    """Запрос данных от поставщика"""
    __tablename__ = 'data_requests'
    
    id = db.Column(db.Integer, primary_key=True)
    supplier_id = db.Column(db.Integer, db.ForeignKey('suppliers.id'), nullable=False)
    
    # Категории и подкатегории, по которым запрашиваются данные
    category_id = db.Column(db.Integer, db.ForeignKey('product_categories.id'), nullable=False)
    subcategory_ids = db.Column(db.JSON)  # Список ID подкатегорий
    
    # Статус запроса
    status = db.Column(db.Enum(DataRequestStatus), default=DataRequestStatus.NEW)
    
    # Даты
    request_sent_at = db.Column(db.DateTime)  # Когда отправлен запрос
    data_received_at = db.Column(db.DateTime)  # Когда получены данные
    deadline = db.Column(db.DateTime)  # Срок получения данных
    
    # Информация о запросе
    requested_by_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    request_message = db.Column(db.Text)  # Текст запроса (опционально)
    response_message = db.Column(db.Text)  # Ответ поставщика (опционально)
    
    # Связь с файлом (когда данные получены)
    import_history_id = db.Column(db.Integer, db.ForeignKey('import_history.id'))
    
    # Метаданные
    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Связи
    supplier = db.relationship('Supplier', backref='data_requests')
    category = db.relationship('ProductCategory', backref='data_requests')
    requested_by = db.relationship('User', foreign_keys=[requested_by_id], backref='data_requests')
    import_file = db.relationship('ImportHistory', foreign_keys=[import_history_id], backref='data_request')
    
    def to_dict(self):
        """Сериализация в словарь"""
        return {
            'id': self.id,
            'supplier_id': self.supplier_id,
            'supplier_name': self.supplier.name if self.supplier else None,
            'category_id': self.category_id,
            'category_name': self.category.name if self.category else None,
            'subcategory_ids': self.subcategory_ids or [],
            'status': self.status.value if isinstance(self.status, enum.Enum) else self.status,
            'request_sent_at': self.request_sent_at.isoformat() if self.request_sent_at else None,
            'data_received_at': self.data_received_at.isoformat() if self.data_received_at else None,
            'deadline': self.deadline.isoformat() if self.deadline else None,
            'requested_by': self.requested_by.username if self.requested_by else None,
            'request_message': self.request_message,
            'response_message': self.response_message,
            'import_history_id': self.import_history_id,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None,
        }
```

### 3.2. Расширение модели Supplier

```python
class Supplier(db.Model):
    # ... существующие поля ...
    
    # Статистика по запросам
    def get_data_requests_stats(self):
        """Получить статистику по запросам данных"""
        from app.models.data_request import DataRequest, DataRequestStatus
        
        requests = DataRequest.query.filter_by(supplier_id=self.id).all()
        
        return {
            'total': len(requests),
            'new': len([r for r in requests if r.status == DataRequestStatus.NEW]),
            'request_sent': len([r for r in requests if r.status == DataRequestStatus.REQUEST_SENT]),
            'data_received': len([r for r in requests if r.status == DataRequestStatus.DATA_RECEIVED]),
            'no_response': len([r for r in requests if r.status == DataRequestStatus.NO_RESPONSE]),
        }
```

### 3.3. Связь с ImportHistory

```python
class ImportHistory(db.Model):
    # ... существующие поля ...
    
    # Связь с запросом данных
    data_request_id = db.Column(db.Integer, db.ForeignKey('data_requests.id'))
    data_request = db.relationship('DataRequest', foreign_keys=[data_request_id], backref='imports')
```

---

## 4. UX/UI ДИЗАЙН

### 4.1. Вкладка "Сбор данных"

#### 4.1.1. Структура вкладки

```
┌─────────────────────────────────────────────────────────────┐
│  СТАТИСТИКА                                                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │
│  │Поставщики│ │Запросы   │ │Получено  │ │Ожидают   │     │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘     │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  БЫСТРЫЕ ДЕЙСТВИЯ                                            │
│  [Создать поставщика] [Отправить запрос] [Скачать шаблон] │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  ПОСТАВЩИКИ (таблица/карточки)                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Код │ Название │ Категории │ Запросы │ Статус │ ... │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  ЗАПРОСЫ ДАННЫХ (таблица)                                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Поставщик │ Категория │ Подкатегории │ Статус │ ... │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 4.1.2. Раздел "Поставщики"

**Отображение:**
- Таблица или карточки поставщиков
- Информация: код, название, категории, количество запросов, статус
- Индикаторы:
  - 🟢 Есть данные (data_received)
  - 🟡 Ожидают ответа (request_sent)
  - 🔴 Нет ответа (no_response)
  - ⚪ Новый (new)

**Действия:**
- "Создать поставщика" (кнопка сверху)
- "Отправить запрос" (для каждого поставщика)
- "Скачать шаблон" (если есть привязанные категории)
- "Редактировать"
- "Просмотреть запросы"

**Фильтры:**
- По статусу запросов
- По категориям
- По наличию данных

#### 4.1.3. Раздел "Запросы данных"

**Отображение:**
- Таблица запросов
- Колонки:
  - Поставщик
  - Категория
  - Подкатегории (список)
  - Статус (badge)
  - Дата отправки
  - Срок (deadline)
  - Дата получения
  - Действия

**Статусы (badges):**
- `new` - Новый (серый)
- `request_sent` - Отправлен (синий)
- `data_received` - Получено (зеленый)
- `no_response` - Нет ответа (красный)
- `cancelled` - Отменен (серый)

**Действия:**
- "Отправить запрос" (для статуса new)
- "Отметить получено" (для статуса request_sent)
- "Просмотреть детали"
- "Отменить запрос"
- "Скачать шаблон"

**Фильтры:**
- По поставщику
- По категории
- По статусу
- По дате отправки
- По сроку (просроченные, сегодня, будущие)

#### 4.1.4. Модальное окно "Отправить запрос"

**Поля:**
- Поставщик (выбор из списка)
- Категория (выбор)
- Подкатегории (множественный выбор для выбранной категории)
- Срок получения (дата)
- Сообщение (опционально, текст запроса)

**Действия:**
- "Отправить" - создает запрос со статусом `request_sent`
- "Сохранить черновик" - создает запрос со статусом `new`
- "Отмена"

**Автоматические действия:**
- Генерация шаблона для поставщика (если нужно)
- Отправка email поставщику (будущее)
- Создание напоминания о сроке

#### 4.1.5. Модальное окно "Отметить получено"

**Поля:**
- Файл (загрузка)
- Дата получения (автоматически = сейчас)
- Комментарий (опционально)

**Действия:**
- "Загрузить и импортировать" - загружает файл и создает ImportHistory
- "Только отметить" - только меняет статус запроса
- "Отмена"

**Автоматические действия:**
- Создание ImportHistory
- Связывание с DataRequest
- Переход в статус `data_received`
- Автоматический импорт (опционально)

### 4.2. Интеграция с другими вкладками

#### 4.2.1. Вкладка "В обработке"

**Связь с запросами:**
- Показывать, из какого запроса пришел файл
- Ссылка на запрос данных
- Информация о поставщике и категориях

#### 4.2.2. Вкладка "В каталоге"

**Связь с запросами:**
- Показывать, из какого запроса пришли данные
- Статистика по запросам
- Фильтрация по запросам

#### 4.2.3. Вкладка "Экспортировано"

**Связь с запросами:**
- Показывать, из какого запроса экспортированы данные
- Статистика выполнения запросов

---

## 5. ФУНКЦИОНАЛЬНОСТЬ

### 5.1. Создание поставщика

**В контексте вкладки "Сбор данных":**
- Быстрое создание поставщика
- Сразу привязка к категориям
- Возможность сразу отправить запрос

### 5.2. Отправка запроса

**Процесс:**
1. Выбор поставщика
2. Выбор категории
3. Выбор подкатегорий (из доступных для категории)
4. Установка срока
5. Написание сообщения (опционально)
6. Отправка запроса

**Автоматические действия:**
- Создание DataRequest со статусом `request_sent`
- Генерация шаблона (если нужно)
- Отправка email (будущее)
- Создание напоминания

### 5.3. Отслеживание получения

**Способы получения данных:**
1. **Загрузка файла** - пользователь загружает файл от поставщика
2. **Автоматическое получение** - интеграция с системой поставщика (будущее)
3. **Email** - получение файла по email (будущее)

**При получении:**
- Обновление статуса запроса на `data_received`
- Создание ImportHistory
- Связывание с DataRequest
- Автоматический переход файла в статус `processing`

### 5.4. Управление запросами

**Действия:**
- Отменить запрос
- Изменить срок
- Отправить напоминание
- Просмотреть историю
- Повторить запрос

### 5.5. Статистика и аналитика

**Метрики:**
- Количество поставщиков
- Количество активных запросов
- Количество полученных данных
- Процент выполнения запросов
- Среднее время получения данных
- Просроченные запросы

---

## 6. ПРЕИМУЩЕСТВА РЕШЕНИЯ

### 6.1. Полный контроль процесса

- Видимость всех поставщиков и их статусов
- Отслеживание всех запросов
- Контроль получения данных

### 6.2. Удобство работы

- Все действия в одном месте
- Быстрое создание поставщиков и запросов
- Автоматизация рутинных операций

### 6.3. Прозрачность

- Понятный статус каждого запроса
- История всех операций
- Статистика и аналитика

### 6.4. Масштабируемость

- Поддержка множества поставщиков
- Управление множеством запросов
- Интеграция с внешними системами (будущее)

---

## 7. ПЛАН РЕАЛИЗАЦИИ

### Этап 1: Модель данных (1 день)
- Создать модель DataRequest
- Расширить ImportHistory
- Миграция базы данных

### Этап 2: Сервисы (2 дня)
- Создать DataRequestService
- Обновить ImportService
- Интеграция с существующими сервисами

### Этап 3: UI вкладки "Сбор данных" (3 дня)
- Раздел "Поставщики"
- Раздел "Запросы данных"
- Модальные окна
- Фильтры и поиск

### Этап 4: Интеграция (1 день)
- Связь с другими вкладками
- Обновление существующих страниц
- Тестирование

**Итого:** ~7 дней работы

---

## 8. АЛЬТЕРНАТИВНЫЕ ВАРИАНТЫ

### Вариант A: Упрощенный

Только отслеживание файлов без запросов:
- Поставщики
- Файлы от поставщиков
- Статусы файлов

**Плюсы:** Проще реализация  
**Минусы:** Нет контроля запросов

### Вариант B: Расширенный

Добавить планирование и автоматизацию:
- Планирование запросов
- Автоматическая отправка
- Интеграция с email
- Напоминания

**Плюсы:** Максимальная автоматизация  
**Минусы:** Сложнее реализация

**Рекомендация:** Вариант из раздела 2-6 - оптимальный баланс функциональности и сложности.

---

**Дата создания:** 2024  
**Версия:** 2.0  
**Статус:** Готово к реализации

