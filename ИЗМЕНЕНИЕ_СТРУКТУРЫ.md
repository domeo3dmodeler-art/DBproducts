# ИЗМЕНЕНИЕ СТРУКТУРЫ ДАННЫХ

## НОВАЯ ЛОГИКА

### Было:
- Категория → Поставщик → Подкатегория → Товар
- Поставщик привязан к одной категории
- Подкатегория привязана к одному поставщику

### Стало:
- **Каталог первичен:** Категория → Подкатегория
- **Поставщики привязываются:** Поставщик → Категории (many-to-many)
- **Поставщики выбирают подкатегории:** Поставщик → Подкатегории (many-to-many)
- **Товар:** Товар → Подкатегория

## ИЗМЕНЕНИЯ В МОДЕЛЯХ

### 1. Subcategory
- ✅ Добавлено: `category_id` (обязательное)
- ✅ Убрано: `supplier_id` (обязательное)
- ✅ Добавлено: связь many-to-many с Supplier через таблицу `supplier_subcategories`
- ✅ Уникальность: `code` + `category_id` (вместо `code` + `supplier_id`)

### 2. Supplier
- ✅ Убрано: `category_id` (обязательное)
- ✅ Добавлено: связь many-to-many с Category через таблицу `supplier_categories`
- ✅ Добавлено: связь many-to-many с Subcategory через таблицу `supplier_subcategories`
- ✅ Уникальность: `code` (глобально уникальный)

### 3. ProductCategory
- ✅ Добавлено: связь с Subcategory (один-ко-многим)
- ✅ Добавлено: связь many-to-many с Supplier

## ИЗМЕНЕНИЯ В ФОРМАХ

### 1. SubcategoryForm
- ✅ Заменено: `supplier_id` → `category_id`
- ✅ Выбор категории из каталога

### 2. SupplierForm
- ✅ Заменено: `category_id` → `category_ids` (множественный выбор)
- ✅ Добавлено: `subcategory_ids` (множественный выбор)
- ✅ Поставщик может выбрать несколько категорий и подкатегорий

## ИЗМЕНЕНИЯ В РОУТАХ

### 1. Создание/редактирование поставщика
- ✅ Убрана проверка уникальности кода в категории
- ✅ Добавлена работа с many-to-many связями
- ✅ При сохранении привязываются выбранные категории и подкатегории

### 2. Создание/редактирование подкатегории
- ✅ Заменена проверка уникальности: `code` + `category_id` (вместо `code` + `supplier_id`)
- ✅ Подкатегория создается в категории

### 3. Списки
- ✅ Подкатегории фильтруются по категории (вместо поставщика)
- ✅ Поставщики фильтруются по категории через many-to-many связь

## ИЗМЕНЕНИЯ В ИМПОРТЕ

### ImportService
- ✅ Убран параметр `supplier_id` из `import_from_file()`
- ✅ Товар привязывается только к подкатегории
- ✅ Поставщик определяется автоматически через связь с подкатегорией

### ImportForm
- ✅ Убрано поле `supplier_id`
- ✅ Осталось только поле `subcategory_id`
- ✅ Подкатегории отображаются с указанием категории: "Категория → Подкатегория"

## ИЗМЕНЕНИЯ В UI

### 1. Список подкатегорий
- ✅ Фильтр по категории (вместо поставщика)
- ✅ Отображение категории и списка поставщиков
- ✅ Убрана колонка "Поставщик" (один), добавлена "Поставщики" (множественное)

### 2. Список поставщиков
- ✅ Отображение списка категорий (вместо одной)
- ✅ Отображение количества подкатегорий
- ✅ Фильтрация по категории через many-to-many

### 3. Форма создания подкатегории
- ✅ Выбор категории (вместо поставщика)
- ✅ Подсказка: "Выберите категорию из каталога"

### 4. Форма создания поставщика
- ✅ Множественный выбор категорий
- ✅ Множественный выбор подкатегорий
- ✅ Подсказки для пользователя

## ПОРЯДОК РАБОТЫ

### 1. Создание каталога
1. Создать **Категорию**
2. Создать **Подкатегорию** в категории
3. Настроить **Атрибуты** для подкатегории

### 2. Создание поставщика
1. Создать **Поставщика**
2. Выбрать **Категории**, с которыми работает поставщик
3. Выбрать **Подкатегории**, которые поставляет поставщик

### 3. Импорт товаров
1. Выбрать **Подкатегорию** из каталога
2. Загрузить файл с товарами
3. Товары автоматически привязываются к подкатегории
4. Поставщик определяется через связь с подкатегорией

## МИГРАЦИЯ БАЗЫ ДАННЫХ

⚠️ **ВАЖНО:** Требуется миграция базы данных!

1. Создать таблицы связи:
   - `supplier_categories`
   - `supplier_subcategories`

2. Перенести данные:
   - Для каждой подкатегории: взять `category_id` из связанного поставщика
   - Для каждого поставщика: создать связь с категорией через `supplier_categories`
   - Для каждого поставщика: создать связи с подкатегориями через `supplier_subcategories`

3. Удалить старые поля:
   - `suppliers.category_id`
   - `subcategories.supplier_id`

4. Обновить ограничения уникальности

## ПРЕИМУЩЕСТВА НОВОЙ СТРУКТУРЫ

1. ✅ **Каталог первичен** - сначала создается структура товаров
2. ✅ **Гибкость** - поставщик может работать с несколькими категориями
3. ✅ **Выборочность** - поставщик выбирает конкретные подкатегории
4. ✅ **Масштабируемость** - легко добавлять новых поставщиков к существующим категориям
5. ✅ **Логичность** - каталог не зависит от поставщиков

---

**Дата:** 2024
**Версия:** 3.0

