# WORKFLOW УПРАВЛЕНИЯ ФАЙЛАМИ ОТ ПОСТАВЩИКОВ

**Дата:** 2024  
**Версия:** 1.0

---

## 1. ПОНИМАНИЕ ЗАДАЧИ

### 1.1. Текущая ситуация

Система сейчас управляет **товарами** через workflow (draft → in_progress → to_review → approved → exported), но не управляет **файлами от поставщиков** на всех этапах их обработки.

### 1.2. Требуемый функционал

Необходимо создать **полный workflow для файлов от поставщиков**, который охватывает весь процесс от получения файла до загрузки данных в основную БД:

1. **Получение файла от поставщика** → файл сохранен, но еще не обработан
2. **Обработка файла** → импорт данных, валидация, подготовка
3. **Данные в каталоге** → товары созданы в системе, прошли верификацию
4. **Данные в основной БД** → товары экспортированы в основную производственную БД

### 1.3. Бизнес-логика

**Цель:** Прозрачное управление процессом обработки данных от поставщиков с возможностью отслеживания на каждом этапе.

**Преимущества:**
- Видимость всех файлов на разных этапах
- Контроль процесса обработки
- Отслеживание прогресса
- Быстрый доступ к нужным файлам/данным

---

## 2. ПРЕДЛОЖЕННОЕ РЕШЕНИЕ

### 2.1. Workflow статусов файлов

Предлагаю следующую структуру workflow:

```
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 1: НОВЫЕ ФАЙЛЫ                                        │
│  Файлы от поставщиков, еще не взяты в работу                │
│  Статус: pending                                             │
└─────────────────────────────────────────────────────────────┘
                    ↓ (взять в работу)
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 2: В ОБРАБОТКЕ                                         │
│  Файлы, которые импортируются и готовятся                   │
│  Статус: processing                                          │
└─────────────────────────────────────────────────────────────┘
                    ↓ (импорт завершен)
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 3: В КАТАЛОГЕ                                          │
│  Данные загружены в каталог, товары созданы                 │
│  Статус: in_catalog                                          │
└─────────────────────────────────────────────────────────────┘
                    ↓ (экспорт в основную БД)
┌─────────────────────────────────────────────────────────────┐
│  ЭТАП 4: ЭКСПОРТИРОВАНО                                      │
│  Данные выгружены в основную БД                              │
│  Статус: exported                                            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2. Названия вкладок (предложение)

**Вариант 1 (краткий):**
1. **Новые файлы** - файлы от поставщиков
2. **В обработке** - импорт и подготовка
3. **В каталоге** - товары в системе
4. **Экспортировано** - в основной БД

**Вариант 2 (описательный):**
1. **Ожидают обработки** - новые файлы от поставщиков
2. **В процессе импорта** - файлы обрабатываются
3. **Загружено в каталог** - товары в системе
4. **Экспортировано в БД** - данные в основной БД

**Вариант 3 (с иконками):**
1. **📥 Новые файлы** - файлы от поставщиков
2. **⚙️ В обработке** - импорт и подготовка
3. **📦 В каталоге** - товары в системе
4. **✅ Экспортировано** - в основной БД

**Рекомендация:** Вариант 1 (краткий) - наиболее понятный и лаконичный.

### 2.3. Архитектура данных

#### 2.3.1. Расширение модели ImportHistory

```python
class ImportFileStatus(enum.Enum):
    """Статусы файлов импорта"""
    PENDING = 'pending'           # Новый файл, ожидает обработки
    PROCESSING = 'processing'      # В процессе импорта
    IN_CATALOG = 'in_catalog'     # Данные в каталоге (товары созданы)
    EXPORTED = 'exported'         # Экспортировано в основную БД
    FAILED = 'failed'             # Ошибка обработки

class ImportHistory(db.Model):
    # ... существующие поля ...
    
    # Workflow статус файла
    file_status = db.Column(db.Enum(ImportFileStatus), 
                           default=ImportFileStatus.PENDING)
    
    # Связь с товарами (через импорт)
    products = db.relationship('Product', 
                               foreign_keys='Product.import_history_id',
                               backref='import_file')
    
    # Дата экспорта в основную БД
    exported_at = db.Column(db.DateTime)
    exported_by_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    
    # Связь с экспортом
    export_history = db.relationship('ExportHistory', backref='import_file')
```

#### 2.3.2. Новая модель ExportHistory

```python
class ExportHistory(db.Model):
    """История экспорта данных в основную БД"""
    __tablename__ = 'export_history'
    
    id = db.Column(db.Integer, primary_key=True)
    import_history_id = db.Column(db.Integer, 
                                 db.ForeignKey('import_history.id'))
    
    # Какие товары экспортированы
    products_count = db.Column(db.Integer, default=0)
    
    # Когда и кем экспортировано
    exported_at = db.Column(db.DateTime, default=datetime.utcnow)
    exported_by_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    
    # Результаты экспорта
    status = db.Column(db.String(20))  # success, failed, partial
    error_message = db.Column(db.Text)
    
    # Метаданные экспорта
    export_config = db.Column(db.JSON)  # Конфигурация экспорта
```

#### 2.3.3. Связь с товарами

```python
class Product(db.Model):
    # ... существующие поля ...
    
    # Связь с файлом импорта
    import_history_id = db.Column(db.Integer, 
                                 db.ForeignKey('import_history.id'))
    
    # Статус экспорта в основную БД
    is_exported = db.Column(db.Boolean, default=False)
    exported_at = db.Column(db.DateTime)
```

### 2.4. UX/UI дизайн

#### 2.4.1. Структура главной страницы

```
┌─────────────────────────────────────────────────────────────┐
│  КРАТКАЯ СТАТИСТИКА (4 карточки)                           │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                      │
│  │Кат-ии│ │Пост-и│ │Товары│ │Оценка│                      │
│  └──────┘ └──────┘ └──────┘ └──────┘                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  ВКЛАДКИ WORKFLOW                                            │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ...   │
│  │Новые файлы   │ │В обработке   │ │В каталоге    │       │
│  └──────────────┘ └──────────────┘ └──────────────┘       │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  СОДЕРЖИМОЕ ВКЛАДКИ                                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ Таблица файлов/данных                                │  │
│  │ - Фильтры и поиск                                    │  │
│  │ - Действия                                           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

#### 2.4.2. Вкладка "Новые файлы"

**Содержимое:**
- Таблица файлов со статусом `pending`
- Информация: название файла, поставщик, подкатегория, дата загрузки, размер
- Действия: "Взять в работу", "Удалить", "Скачать"

**Фильтры:**
- По поставщику
- По категории/подкатегории
- По дате загрузки

**Статистика:**
- Количество новых файлов
- Общий размер файлов
- Самый старый файл

#### 2.4.3. Вкладка "В обработке"

**Содержимое:**
- Таблица файлов со статусом `processing`
- Информация: название файла, поставщик, прогресс импорта, статус
- Действия: "Отменить", "Просмотреть логи", "Повторить"

**Индикаторы:**
- Прогресс-бар импорта
- Количество обработанных строк
- Время обработки

**Статистика:**
- Файлов в обработке
- Среднее время обработки
- Успешных/неуспешных импортов

#### 2.4.4. Вкладка "В каталоге"

**Содержимое:**
- Таблица импортов со статусом `in_catalog`
- Информация: файл, поставщик, количество товаров, дата импорта, оценка верификации
- Действия: "Просмотреть товары", "Экспортировать в БД", "Повторная верификация"

**Фильтры:**
- По поставщику
- По оценке верификации
- По дате импорта
- По статусу товаров

**Статистика:**
- Всего товаров в каталоге
- Средняя оценка верификации
- Готовых к экспорту (approved)

#### 2.4.5. Вкладка "Экспортировано"

**Содержимое:**
- Таблица экспортов со статусом `exported`
- Информация: файл, поставщик, количество товаров, дата экспорта, статус
- Действия: "Просмотреть детали", "Повторить экспорт", "Откатить"

**Фильтры:**
- По поставщику
- По дате экспорта
- По статусу экспорта

**Статистика:**
- Всего экспортировано товаров
- Успешных экспортов
- Последний экспорт

### 2.5. Переходы между статусами

#### 2.5.1. Автоматические переходы

- `pending → processing`: при начале импорта
- `processing → in_catalog`: при успешном завершении импорта
- `processing → failed`: при ошибке импорта
- `in_catalog → exported`: при экспорте в основную БД

#### 2.5.2. Ручные переходы

- `pending → processing`: "Взять в работу"
- `processing → pending`: "Отменить обработку"
- `failed → processing`: "Повторить импорт"
- `in_catalog → exported`: "Экспортировать в БД"
- `exported → in_catalog`: "Откатить экспорт" (опционально)

### 2.6. Интеграция с существующим workflow

**Связь с товарами:**
- Товары создаются при импорте файла
- Товары имеют свой workflow (draft → in_progress → ... → exported)
- Файл переходит в `in_catalog`, когда товары созданы
- Файл переходит в `exported`, когда все товары экспортированы

**Логика:**
- Файл может содержать товары с разными статусами
- Файл считается `in_catalog`, если хотя бы один товар создан
- Файл считается `exported`, если все товары экспортированы

---

## 3. ПРЕИМУЩЕСТВА РЕШЕНИЯ

### 3.1. Прозрачность процесса

- Видимость всех файлов на каждом этапе
- Отслеживание прогресса обработки
- История всех операций

### 3.2. Управление

- Контроль процесса обработки
- Возможность отмены/повтора операций
- Массовые операции

### 3.3. Аналитика

- Статистика по этапам
- Время обработки
- Успешность операций

### 3.4. Масштабируемость

- Поддержка больших объемов данных
- Асинхронная обработка (будущее)
- Интеграция с внешними системами

---

## 4. ПЛАН РЕАЛИЗАЦИИ

### Этап 1: Расширение модели данных (1 день)
- Добавить `file_status` в `ImportHistory`
- Создать модель `ExportHistory`
- Добавить связь `import_history_id` в `Product`
- Миграция базы данных

### Этап 2: Обновление сервисов (2 дня)
- Обновить `ImportService` для управления статусами
- Создать `ExportService` для экспорта в основную БД
- Обновить workflow переходов

### Этап 3: UI главной страницы (2 дня)
- Создать вкладки на главной странице
- Реализовать таблицы для каждой вкладки
- Добавить фильтры и поиск
- Добавить действия

### Этап 4: Тестирование (1 день)
- Unit тесты для новых моделей
- Integration тесты для workflow
- E2E тесты для UI

**Итого:** ~6 дней работы

---

## 5. АЛЬТЕРНАТИВНЫЕ ВАРИАНТЫ

### Вариант A: Упрощенный workflow

Только 3 этапа:
1. Новые файлы
2. В каталоге
3. Экспортировано

**Плюсы:** Проще реализация  
**Минусы:** Меньше контроля процесса

### Вариант B: Расширенный workflow

5+ этапов с подэтапами:
1. Новые файлы
2. Валидация
3. Импорт
4. Верификация
5. В каталоге
6. Экспорт
7. В основной БД

**Плюсы:** Максимальный контроль  
**Минусы:** Сложнее реализация и UX

**Рекомендация:** Вариант из раздела 2 (4 этапа) - оптимальный баланс.

---

**Дата создания:** 2024  
**Версия:** 1.0  
**Статус:** Предложение

